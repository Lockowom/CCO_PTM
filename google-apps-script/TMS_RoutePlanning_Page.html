<section class="view" id="tmsRoutePlanningView">
    <!-- Header TMS Premium -->
    <div class="tms-header">
        <div class="header-left">
            <div class="tms-logo-icon"><i class="fas fa-route"></i></div>
            <div class="header-titles">
                <h1>Planificador de Rutas</h1>
                <p>Optimización inteligente de última milla</p>
            </div>
        </div>
        <div class="header-right">
            <div class="kpi-badge">
                <span class="kpi-label">Pendientes</span>
                <span class="kpi-value" id="kpi-pendientes">0</span>
            </div>
            <div class="kpi-badge success">
                <span class="kpi-label">En Ruta</span>
                <span class="kpi-value" id="kpi-enruta">0</span>
            </div>
            <button class="tms-btn-primary" onclick="RoutePlanner.refreshData()">
                <i class="fas fa-sync-alt"></i> Actualizar
            </button>
        </div>
    </div>

    <!-- Layout Principal -->
    <div class="tms-planner-layout">
        
        <!-- Panel Izquierdo: Pool de Entregas (Unassigned) -->
        <div class="planner-panel" id="panel-unassigned">
            <div class="panel-header">
                <h3><i class="fas fa-box-open"></i> Entregas Sin Asignar</h3>
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Buscar por cliente, zona..." onkeyup="RoutePlanner.filterEntregas(this.value)">
                </div>
            </div>
            <div class="panel-content drop-zone" id="pool-entregas" ondragover="RoutePlanner.allowDrop(event)" ondrop="RoutePlanner.drop(event, 'pool')">
                <!-- Loading State -->
                <div class="loading-spinner-container">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Panel Central: Mapa (Visualización) -->
        <div class="planner-map-container">
            <div class="map-toolbar">
                <button class="map-tool active" title="Ver Rutas" onclick="RoutePlanner.fitMapBounds()"><i class="fas fa-expand-arrows-alt"></i></button>
            </div>
            <div id="tms-map" style="width: 100%; height: 100%; z-index: 1;"></div>
        </div>

        <!-- Panel Derecho: Rutas Activas (Assigned) -->
        <div class="planner-panel" id="panel-routes">
            <div class="panel-header">
                <h3><i class="fas fa-truck-moving"></i> Rutas Activas</h3>
                <button class="btn-icon" onclick="RoutePlanner.createNewRoute()" title="Nueva Ruta"><i class="fas fa-plus"></i></button>
            </div>
            <div class="panel-content" id="active-routes-list">
                <!-- Rutas se renderizan aquí -->
            </div>
        </div>

    </div>

    <!-- Modal de Creación de Ruta -->
    <div id="modal-new-route" class="tms-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nueva Ruta</h2>
                <span class="close-modal" onclick="RoutePlanner.closeModal('modal-new-route')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="form-new-route">
                    <div class="form-group">
                        <label>Nombre de Ruta</label>
                        <input type="text" id="route-name" placeholder="Ej: Ruta Norte - Mañana">
                    </div>
                    <div class="form-group">
                        <label>Conductor</label>
                        <select id="route-driver">
                            <option value="">Seleccione conductor...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Vehículo</label>
                        <select id="route-vehicle">
                            <option value="">Seleccione vehículo...</option>
                            <option value="CAMION-01">Camión 01 (5 Ton)</option>
                            <option value="VAN-01">Van Express 01</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="tms-btn-secondary" onclick="RoutePlanner.closeModal('modal-new-route')">Cancelar</button>
                <button class="tms-btn-primary" onclick="RoutePlanner.submitNewRoute()">Crear Ruta</button>
            </div>
        </div>
    </div>

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        :root {
            --tms-primary: #2563eb; /* Azul Tecnológico */
            --tms-secondary: #64748b;
            --tms-success: #10b981;
            --tms-warning: #f59e0b;
            --tms-danger: #ef4444;
            --tms-bg: #f1f5f9;
            --tms-card: #ffffff;
            --tms-border: #e2e8f0;
            --tms-text: #1e293b;
        }

        /* Layout */
        .tms-planner-layout {
            display: grid;
            grid-template-columns: 300px 1fr 350px; /* 3 Columnas */
            gap: 15px;
            padding: 15px;
            height: calc(100vh - 100px);
            background-color: var(--tms-bg);
        }

        /* Header */
        .tms-header {
            background: white;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--tms-border);
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        .header-left { display: flex; align-items: center; gap: 15px; }
        .tms-logo-icon {
            background: linear-gradient(135deg, var(--tms-primary), #1d4ed8);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        .header-titles h1 { margin: 0; font-size: 1.2rem; color: var(--tms-text); }
        .header-titles p { margin: 0; font-size: 0.8rem; color: var(--tms-secondary); }

        .header-right { display: flex; align-items: center; gap: 15px; }

        /* KPIs */
        .kpi-badge {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #f8fafc;
            padding: 5px 15px;
            border-radius: 8px;
            border: 1px solid var(--tms-border);
        }
        .kpi-badge.success { background: #ecfdf5; border-color: #d1fae5; }
        .kpi-label { font-size: 0.7rem; text-transform: uppercase; color: var(--tms-secondary); }
        .kpi-value { font-weight: 700; font-size: 1.1rem; color: var(--tms-text); }
        .kpi-badge.success .kpi-value { color: var(--tms-success); }

        /* Paneles */
        .planner-panel {
            background: var(--tms-card);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--tms-border);
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .panel-header {
            padding: 15px;
            border-bottom: 1px solid var(--tms-border);
            background: #f8fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h3 { margin: 0; font-size: 0.95rem; color: var(--tms-text); font-weight: 600; }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: #f1f5f9; /* Fondo gris claro para las zonas de drop */
        }

        /* Mapa */
        .planner-map-container {
            background: white;
            border-radius: 12px;
            border: 1px solid var(--tms-border);
            position: relative;
            overflow: hidden;
        }
        
        .map-placeholder {
            width: 100%;
            height: 100%;
            background: #e2e8f0 url('data:image/svg+xml;utf8,<svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><circle cx="2" cy="2" r="1" fill="%23cbd5e1"/></svg>');
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .map-message {
            text-align: center;
            color: var(--tms-secondary);
            background: rgba(255,255,255,0.9);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .map-message i { font-size: 3rem; margin-bottom: 15px; color: var(--tms-primary); }

        /* Cards de Entrega (Draggable) */
        .delivery-card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid var(--tms-border);
            border-left: 4px solid var(--tms-warning); /* Default Pendiente */
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .delivery-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .delivery-card:active { cursor: grabbing; }

        .d-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .d-nv { font-weight: 700; color: var(--tms-text); font-size: 0.9rem; }
        .d-bultos { font-size: 0.75rem; background: #eff6ff; color: var(--tms-primary); padding: 2px 6px; border-radius: 4px; }
        
        .d-address { font-size: 0.8rem; color: var(--tms-secondary); margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .d-client { font-size: 0.85rem; font-weight: 500; color: var(--tms-text); }

        /* Cards de Ruta */
        .route-card {
            background: white;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--tms-border);
            overflow: hidden;
        }
        
        .route-header {
            background: #f8fafc;
            padding: 10px 15px;
            border-bottom: 1px solid var(--tms-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .route-title { font-weight: 600; font-size: 0.9rem; }
        .route-driver { font-size: 0.8rem; color: var(--tms-secondary); display: block; }
        
        .route-body {
            padding: 10px;
            min-height: 50px;
        }
        
        .route-stats {
            display: flex;
            justify-content: space-around;
            padding: 8px;
            background: #f1f5f9;
            font-size: 0.75rem;
            color: var(--tms-secondary);
        }

        .route-drop-zone {
            min-height: 40px;
            border: 2px dashed #cbd5e1;
            border-radius: 6px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            font-size: 0.8rem;
        }
        
        .route-drop-zone.drag-over {
            background: #eff6ff;
            border-color: var(--tms-primary);
            color: var(--tms-primary);
        }

        /* Botones */
        .tms-btn-primary {
            background: var(--tms-primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .tms-btn-primary:hover { background: #1d4ed8; }
        
        .tms-btn-secondary {
            background: white;
            color: var(--tms-text);
            border: 1px solid var(--tms-border);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-icon {
            background: none;
            border: none;
            color: var(--tms-primary);
            cursor: pointer;
            font-size: 1.1rem;
        }

        /* Search Bar */
        .search-bar { position: relative; margin-top: 10px; }
        .search-bar i { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        .search-bar input { width: 100%; padding: 6px 10px 6px 30px; border: 1px solid var(--tms-border); border-radius: 6px; }

        /* Loading */
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid var(--tms-primary); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Modal Centrado */
        .tms-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-content { 
            background-color: #fefefe; 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); /* Centrado perfecto */
            padding: 0; 
            border: 1px solid #e2e8f0; 
            width: 400px; 
            border-radius: 12px; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); 
            overflow: hidden; 
        }
        .modal-header { padding: 15px 20px; background: #f8fafc; border-bottom: 1px solid var(--tms-border); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { margin: 0; font-size: 1.1rem; }
        .close-modal { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 15px 20px; background: #f8fafc; border-top: 1px solid var(--tms-border); display: flex; justify-content: flex-end; gap: 10px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid var(--tms-border); border-radius: 6px; }

        /* Responsive */
        @media (max-width: 1200px) {
            .tms-planner-layout { grid-template-columns: 300px 1fr; }
            .planner-map-container { display: none; } /* Ocultar mapa en pantallas medianas */
        }
    </style>

    <script>
        const RoutePlanner = {
            data: {
                unassigned: [],
                routes: [],
                drivers: []
            },
            map: null,
            markers: {},

            init: function() {
                this.initMap();
                this.refreshData();
            },

            initMap: function() {
                // Coordenadas por defecto (Santiago, Chile) - Ajustar según necesidad
                this.map = L.map('tms-map').setView([-33.4489, -70.6693], 11);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(this.map);

                // FIX: Mapa Gris - Recalcular tamaño después de renderizar
                setTimeout(() => {
                    this.map.invalidateSize();
                }, 500);
            },

            updateMapMarkers: function() {
                // Limpiar marcadores antiguos
                for (let id in this.markers) {
                    this.map.removeLayer(this.markers[id]);
                }
                this.markers = {};

                const bounds = [];

                // 1. Marcadores de Pendientes (Rojos)
                this.data.unassigned.forEach(e => {
                    if (e.Latitud && e.Longitud) {
                        const lat = parseFloat(e.Latitud);
                        const lng = parseFloat(e.Longitud);
                        if (!isNaN(lat) && !isNaN(lng)) {
                            const marker = L.circleMarker([lat, lng], {
                                color: '#ef4444', // Rojo
                                fillColor: '#ef4444',
                                fillOpacity: 0.7,
                                radius: 8
                            }).addTo(this.map);
                            
                            marker.bindPopup(`<b>NV ${e.NV}</b><br>${e.Cliente}<br>${e.Direccion}`);
                            this.markers['u_' + e.ID] = marker;
                            bounds.push([lat, lng]);
                        }
                    }
                });

                // 2. Marcadores de Rutas (Azules/Verdes)
                this.data.routes.forEach(r => {
                    if (r.entregas) {
                        r.entregas.forEach(e => {
                            if (e.Latitud && e.Longitud) {
                                const lat = parseFloat(e.Latitud);
                                const lng = parseFloat(e.Longitud);
                                if (!isNaN(lat) && !isNaN(lng)) {
                                    const color = r.Estado === 'EN_RUTA' ? '#10b981' : '#3b82f6'; // Verde o Azul
                                    const marker = L.circleMarker([lat, lng], {
                                        color: color,
                                        fillColor: color,
                                        fillOpacity: 0.7,
                                        radius: 8
                                    }).addTo(this.map);
                                    
                                    marker.bindPopup(`<b>NV ${e.NV}</b><br>Ruta: ${r.Nombre}<br>${e.Cliente}`);
                                    this.markers['r_' + e.ID] = marker;
                                    bounds.push([lat, lng]);
                                }
                            }
                        });
                    }
                });

                // Ajustar vista si hay puntos
                if (bounds.length > 0) {
                    this.map.fitBounds(bounds, { padding: [50, 50] });
                }
            },

            fitMapBounds: function() {
                // Re-centrar mapa
                const bounds = [];
                for (let id in this.markers) {
                    bounds.push(this.markers[id].getLatLng());
                }
                if (bounds.length > 0) {
                    this.map.fitBounds(bounds, { padding: [50, 50] });
                } else {
                     this.map.setView([-33.4489, -70.6693], 11);
                }
            },

            refreshData: function() {
                document.getElementById('pool-entregas').innerHTML = '<div class="spinner"></div>';
                
                // Llamada unificada para evitar "Too many scripts running"
                google.script.run
                    .withSuccessHandler(this.onAllDataLoaded.bind(this))
                    .withFailureHandler(this.onError.bind(this))
                    .getTMSInitialData();
            },

            onAllDataLoaded: function(response) {
                if (!response.success) {
                    this.onError(new Error(response.error));
                    return;
                }

                // 1. Conductores
                this.data.drivers = response.conductores;
                const select = document.getElementById('route-driver');
                select.innerHTML = '<option value="">Seleccione conductor...</option>';
                this.data.drivers.forEach(d => {
                    select.innerHTML += `<option value="${d.ID}">${d.Nombre} (${d.Estado})</option>`;
                });

                // 2. Entregas Pendientes
                this.onDataLoaded(response.entregas);

                // 3. Rutas Activas
                this.onRoutesLoaded(response.rutas);
            },

            // Métodos legacy mantenidos por compatibilidad interna
            refreshRoutes: function() { /* No-op si se usa refreshData */ },
            loadDrivers: function() { /* No-op si se usa refreshData */ },

            onDataLoaded: function(entregas) {
                this.data.unassigned = entregas;
                document.getElementById('kpi-pendientes').innerText = entregas.length;
                this.renderPool();
                this.updateMapMarkers(); // Actualizar mapa
            },

            onRoutesLoaded: function(rutas) {
                this.data.routes = rutas;
                document.getElementById('kpi-enruta').innerText = rutas.filter(r => r.Estado === 'EN_RUTA').length;
                this.renderRoutes();
                this.updateMapMarkers(); // Actualizar mapa
            },

            renderPool: function(filterText = '') {
                const container = document.getElementById('pool-entregas');
                container.innerHTML = '';
                
                const filtered = this.data.unassigned.filter(e => {
                    if(!filterText) return true;
                    const txt = (e.Cliente + ' ' + e.NV + ' ' + e.Direccion).toLowerCase();
                    return txt.includes(filterText.toLowerCase());
                });

                if (filtered.length === 0) {
                    container.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:20px;">No hay entregas pendientes</div>';
                    return;
                }

                filtered.forEach(e => {
                    const card = document.createElement('div');
                    card.className = 'delivery-card';
                    card.draggable = true;
                    card.id = `delivery-${e.ID}`;
                    card.ondragstart = (ev) => this.drag(ev, e.ID);
                    
                    // Alerta si no tiene lat/long
                    const geoWarning = (!e.Latitud || !e.Longitud) ? '<i class="fas fa-exclamation-triangle" style="color:#f59e0b; margin-left:5px;" title="Sin coordenadas"></i>' : '';

                    card.innerHTML = `
                        <div class="d-header">
                            <span class="d-nv">NV ${e.NV}</span>
                            <span class="d-bultos"><i class="fas fa-box"></i> ${e.Bultos}</span>
                        </div>
                        <div class="d-client">${e.Cliente} ${geoWarning}</div>
                        <div class="d-address"><i class="fas fa-map-marker-alt"></i> ${e.Direccion || 'Sin dirección'}</div>
                    `;
                    container.appendChild(card);
                });
            },

            renderRoutes: function() {
                const container = document.getElementById('active-routes-list');
                container.innerHTML = '';

                if (!this.data.routes || this.data.routes.length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding:20px; color:#94a3b8;">No hay rutas activas</div>';
                    return;
                }

                this.data.routes.forEach(r => {
                    // Calcular bultos totales
                    const totalBultos = r.entregas ? r.entregas.reduce((sum, e) => sum + (Number(e.Bultos) || 0), 0) : 0;

                    const div = document.createElement('div');
                    div.className = 'route-card';
                    div.id = `route-${r.id}`; // ID para drop target
                    
                    // Generar lista de entregas (mini-items)
                    let entregasHtml = '';
                    if (r.entregas && r.entregas.length > 0) {
                        entregasHtml = '<div class="route-items-list">';
                        r.entregas.forEach(e => {
                            entregasHtml += `
                                <div class="route-mini-item">
                                    <span class="mini-nv">NV ${e.NV || 'S/N'}</span>
                                    <span class="mini-client">${e.Cliente || 'Sin Cliente'}</span>
                                    <span class="mini-bultos"><i class="fas fa-box"></i> ${e.Bultos || 0}</span>
                                    <button class="btn-remove-item" onclick="RoutePlanner.removeFromRoute('${r.id}', '${e.ID}')" title="Quitar de ruta">&times;</button>
                                </div>
                            `;
                        });
                        entregasHtml += '</div>';
                    } else {
                        entregasHtml = '<div class="route-empty-msg">Arrastra entregas aquí</div>';
                    }

                    div.innerHTML = `
                        <div class="route-header">
                            <div>
                                <div class="route-title">${r.nombre || 'Ruta Sin Nombre'}</div>
                                <span class="route-driver"><i class="fas fa-user"></i> ${r.conductor ? (r.conductor.Nombre || r.conductor.ID) : 'Sin Asignar'}</span>
                            </div>
                            <span class="kpi-badge ${r.estado === 'EN_RUTA' ? 'success' : ''}">${r.estado || 'PLANIFICADA'}</span>
                        </div>
                        <div class="route-stats">
                            <span><i class="fas fa-flag-checkered"></i> ${r.totalEntregas || 0} Entregas</span>
                            <span><i class="fas fa-cubes"></i> ${totalBultos} Bultos</span>
                        </div>
                        <div class="route-body">
                            <div class="route-drop-zone" 
                                 ondragover="RoutePlanner.allowDrop(event)" 
                                 ondrop="RoutePlanner.drop(event, 'route', '${r.id}')">
                                 ${entregasHtml}
                            </div>
                        </div>
                        <div class="route-actions">
                            <button class="btn-action small" onclick="RoutePlanner.optimizeRoute('${r.id}')"><i class="fas fa-magic"></i> Optimizar</button>
                            <button class="btn-action small danger" onclick="RoutePlanner.deleteRoute('${r.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            },

            // Drag & Drop Logic
            drag: function(ev, id) {
                ev.dataTransfer.setData("text", id);
                ev.target.classList.add('dragging');
            },

            allowDrop: function(ev) {
                ev.preventDefault();
                if(ev.target.classList.contains('route-drop-zone')) {
                    ev.target.classList.add('drag-over');
                }
            },

            drop: function(ev, targetType, targetId) {
                ev.preventDefault();
                const deliveryId = ev.dataTransfer.getData("text");
                const card = document.getElementById(`delivery-${deliveryId}`);
                card.classList.remove('dragging');
                
                if (ev.target.classList.contains('route-drop-zone')) {
                    ev.target.classList.remove('drag-over');
                }

                if (targetType === 'route') {
                    // Asignar a ruta
                    this.assignToRoute(deliveryId, targetId);
                }
            },

            assignToRoute: function(deliveryId, routeId) {
                // UI Optimista
                const card = document.getElementById(`delivery-${deliveryId}`);
                if(card) card.style.opacity = '0.5';

                google.script.run
                    .withSuccessHandler(() => {
                        if(window.WMSToast) WMSToast.success('Entrega asignada a ruta');
                        this.refreshData(); // Recargar todo
                    })
                    .asignarEntregasARuta(routeId, [deliveryId]);
            },

            // Modal Logic
            createNewRoute: function() {
                document.getElementById('modal-new-route').style.display = 'block';
            },

            closeModal: function(id) {
                document.getElementById(id).style.display = 'none';
            },

            submitNewRoute: function() {
                const name = document.getElementById('route-name').value;
                const driverId = document.getElementById('route-driver').value;
                
                if(!name || !driverId) {
                    alert('Complete todos los campos');
                    return;
                }

                const data = {
                    nombre: name,
                    conductorId: driverId,
                    fechaPlanificada: new Date().toISOString()
                };

                google.script.run
                    .withSuccessHandler(() => {
                        this.closeModal('modal-new-route');
                        this.refreshRoutes();
                        if(window.WMSToast) WMSToast.success('Ruta creada exitosamente');
                    })
                    .crearNuevaRuta(data);
            },

            filterEntregas: function(val) {
                this.renderPool(val);
            },

            onError: function(err) {
                console.error(err);
                alert('Error: ' + err.message);
            }
        };

        // Auto-init (Legacy support)
        setTimeout(() => RoutePlanner.init(), 500);

        // Global init function for Navigation Handler
        function initRoutePlanning() {
            console.log('TMS Route Planning: Initializing via Navigation Handler');
            RoutePlanner.init();
        }
    </script>
</section>
