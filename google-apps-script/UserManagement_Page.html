<section class="view" id="usersView">
<!-- UserManagement_Page.html - Gesti칩n de Usuarios con Dise침o WMS Moderno -->

<div class="wms-page-container">
  <!-- Module Header -->
  <div class="wms-module-header">
    <div class="wms-breadcrumb">
      <a href="#" onclick="showView('dashboard'); return false;">
        <i class="fas fa-home"></i> Inicio
      </a>
      <i class="fas fa-chevron-right"></i>
      <span>Administraci칩n</span>
      <i class="fas fa-chevron-right"></i>
      <span>Usuarios</span>
    </div>
    
    <div class="wms-header-content">
      <div class="wms-header-icon">
        <i class="fas fa-users-cog"></i>
      </div>
      <div class="wms-header-text">
        <h1>Gesti칩n de Usuarios</h1>
        <p>Administraci칩n de accesos y credenciales del sistema</p>
      </div>
    </div>
    
    <div class="wms-quick-actions">
      <button class="wms-btn wms-btn-secondary" onclick="UsersModule.loadUsers()" aria-label="Actualizar">
        <i class="fas fa-sync-alt"></i>
        <span>Actualizar</span>
      </button>
      <button class="wms-btn wms-btn-primary" onclick="UsersModule.openModal()">
        <i class="fas fa-user-plus"></i>
        <span>Nuevo Usuario</span>
      </button>
    </div>
  </div>

  <!-- Stats Grid -->
  <div class="wms-stats-grid">
    <div class="wms-stat-card" data-type="info">
      <div class="wms-stat-icon"><i class="fas fa-users"></i></div>
      <div class="wms-stat-content">
        <span class="wms-stat-value" id="statUsersTotal">0</span>
        <span class="wms-stat-label">Total Usuarios</span>
      </div>
    </div>
    <div class="wms-stat-card" data-type="success">
      <div class="wms-stat-icon"><i class="fas fa-user-check"></i></div>
      <div class="wms-stat-content">
        <span class="wms-stat-value" id="statUsersActive">0</span>
        <span class="wms-stat-label">Usuarios Activos</span>
      </div>
    </div>
    <div class="wms-stat-card" data-type="warning">
      <div class="wms-stat-icon"><i class="fas fa-crown"></i></div>
      <div class="wms-stat-content">
        <span class="wms-stat-value" id="statUsersAdmin">0</span>
        <span class="wms-stat-label">Administradores</span>
      </div>
    </div>
    <div class="wms-stat-card" data-type="purple">
      <div class="wms-stat-icon"><i class="fas fa-user-tie"></i></div>
      <div class="wms-stat-content">
        <span class="wms-stat-value" id="statUsersSupervisor">0</span>
        <span class="wms-stat-label">Supervisores</span>
      </div>
    </div>
  </div>

  <!-- Search and Filter Bar -->
  <div class="users-toolbar">
    <div class="users-search">
      <i class="fas fa-search"></i>
      <input type="text" id="usersSearchInput" placeholder="Buscar por nombre, email o rol..." oninput="UsersModule.filterUsers()">
    </div>
    <div class="users-filters">
      <select id="usersRoleFilter" onchange="UsersModule.filterUsers()">
        <option value="">Todos los roles</option>
      </select>
      <select id="usersStatusFilter" onchange="UsersModule.filterUsers()">
        <option value="">Todos los estados</option>
        <option value="active">Activos</option>
        <option value="inactive">Inactivos</option>
      </select>
    </div>
  </div>

  <!-- Users Grid -->
  <div class="users-grid" id="usersGrid">
    <div class="users-loading">
      <i class="fas fa-spinner fa-spin"></i>
      <span>Cargando usuarios...</span>
    </div>
  </div>
</div>

<!-- User Modal -->
<div class="users-modal-overlay" id="userModal">
  <div class="users-modal">
    <div class="users-modal-header">
      <div class="users-modal-title">
        <i class="fas fa-user-plus" id="modalIcon"></i>
        <span id="modalTitle">Nuevo Usuario</span>
      </div>
      <button class="users-modal-close" onclick="UsersModule.closeModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <form id="userForm" onsubmit="UsersModule.saveUser(event)">
      <div class="users-modal-body">
        <input type="hidden" id="userId">
        
        <div class="users-form-group">
          <label class="users-label">
            <i class="fas fa-user"></i>
            Nombre Completo <span class="required">*</span>
          </label>
          <input type="text" id="userName" class="users-input" placeholder="Ej: Juan P칠rez" required minlength="2">
        </div>
        
        <div class="users-form-group">
          <label class="users-label">
            <i class="fas fa-envelope"></i>
            Email <span class="required">*</span>
          </label>
          <input type="email" id="userEmail" class="users-input" placeholder="correo@ejemplo.com" required>
        </div>
        
        <div class="users-form-group">
          <label class="users-label">
            <i class="fas fa-lock"></i>
            Contrase침a <span class="required" id="passwordRequired">*</span>
          </label>
          <div class="users-password-wrapper">
            <input type="password" id="userPassword" class="users-input" placeholder="M칤nimo 6 caracteres" minlength="6">
            <button type="button" class="users-password-toggle" onclick="UsersModule.togglePassword()">
              <i class="fas fa-eye" id="passwordToggleIcon"></i>
            </button>
          </div>
          <span class="users-helper" id="passwordHelper">M칤nimo 6 caracteres</span>
        </div>
        
        <div class="users-form-row">
          <div class="users-form-group">
            <label class="users-label">
              <i class="fas fa-user-tag"></i>
              Rol <span class="required">*</span>
            </label>
            <select id="userRole" class="users-select" required>
              <option value="">Seleccionar rol...</option>
            </select>
          </div>
          
          <div class="users-form-group">
            <label class="users-label">
              <i class="fas fa-toggle-on"></i>
              Estado
            </label>
            <div class="users-toggle-wrapper">
              <label class="users-toggle">
                <input type="checkbox" id="userActive" checked>
                <span class="users-toggle-slider"></span>
              </label>
              <span class="users-toggle-label" id="userActiveLabel">Activo</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="users-modal-footer">
        <button type="button" class="users-btn users-btn-secondary" onclick="UsersModule.closeModal()">
          <i class="fas fa-times"></i>
          Cancelar
        </button>
        <button type="submit" class="users-btn users-btn-primary" id="btnSaveUser">
          <i class="fas fa-save"></i>
          <span>Guardar Usuario</span>
        </button>
      </div>
    </form>
  </div>
</div>


<style>
/* ==================== USERS MODULE - MODERN DESIGN ==================== */

/* Toolbar */
.users-toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  margin-top: 24px;
  padding: 16px 20px;
  background: white;
  border-radius: 12px;
  border: 1px solid #e5e7eb;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.users-search {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
  max-width: 400px;
  padding: 10px 16px;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 10px;
  transition: all 0.2s ease;
}

.users-search:focus-within {
  background: white;
  border-color: #FF6B00;
  box-shadow: 0 0 0 3px rgba(255,107,0,0.1);
}

.users-search i {
  color: #94a3b8;
  font-size: 0.9rem;
}

.users-search input {
  flex: 1;
  border: none;
  background: transparent;
  font-size: 0.9rem;
  color: #1e293b;
  outline: none;
}

.users-search input::placeholder {
  color: #94a3b8;
}

.users-filters {
  display: flex;
  align-items: center;
  gap: 12px;
}

.users-filters select {
  padding: 10px 16px;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 10px;
  font-size: 0.9rem;
  color: #475569;
  cursor: pointer;
  outline: none;
  transition: all 0.2s ease;
}

.users-filters select:focus {
  border-color: #FF6B00;
  box-shadow: 0 0 0 3px rgba(255,107,0,0.1);
}

/* Users Grid */
.users-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 20px;
  margin-top: 24px;
}

.users-loading {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  padding: 60px;
  color: #6b7280;
  font-size: 1rem;
}

.users-loading i {
  font-size: 1.5rem;
  color: #FF6B00;
}

.users-empty {
  grid-column: 1 / -1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  padding: 60px;
  color: #6b7280;
}

.users-empty i {
  font-size: 3rem;
  color: #d1d5db;
}

/* User Card */
.user-card {
  background: white;
  border-radius: 16px;
  border: 1px solid #e5e7eb;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  transition: all 0.3s ease;
}

.user-card:hover {
  box-shadow: 0 8px 25px rgba(0,0,0,0.08);
  border-color: #d1d5db;
  transform: translateY(-2px);
}

.user-card-header {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-bottom: 1px solid #e5e7eb;
}

.user-avatar {
  width: 56px;
  height: 56px;
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
  font-weight: 700;
  color: white;
  flex-shrink: 0;
}

.user-avatar.admin {
  background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
  box-shadow: 0 4px 12px rgba(239,68,68,0.3);
}

.user-avatar.supervisor {
  background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
  box-shadow: 0 4px 12px rgba(245,158,11,0.3);
}

.user-avatar.operador {
  background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
  box-shadow: 0 4px 12px rgba(16,185,129,0.3);
}

.user-avatar.default {
  background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
  box-shadow: 0 4px 12px rgba(59,130,246,0.3);
}

.user-info {
  flex: 1;
  min-width: 0;
}

.user-info h3 {
  font-size: 1.1rem;
  font-weight: 700;
  color: #1e293b;
  margin: 0 0 4px 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.user-info p {
  font-size: 0.85rem;
  color: #64748b;
  margin: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.user-status {
  padding: 4px 10px;
  border-radius: 50px;
  font-size: 0.75rem;
  font-weight: 600;
}

.user-status.active {
  background: #ecfdf5;
  color: #059669;
}

.user-status.inactive {
  background: #fef2f2;
  color: #dc2626;
}

.user-card-body {
  padding: 16px 20px;
}

.user-detail {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 0;
  border-bottom: 1px solid #f1f5f9;
}

.user-detail:last-child {
  border-bottom: none;
}

.user-detail i {
  width: 20px;
  text-align: center;
  color: #94a3b8;
  font-size: 0.9rem;
}

.user-detail span {
  font-size: 0.9rem;
  color: #475569;
}

.user-role-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 12px;
  border-radius: 50px;
  font-size: 0.8rem;
  font-weight: 600;
}

.user-role-badge.admin {
  background: #fef2f2;
  color: #dc2626;
}

.user-role-badge.supervisor {
  background: #fffbeb;
  color: #d97706;
}

.user-role-badge.operador {
  background: #ecfdf5;
  color: #059669;
}

.user-role-badge.default {
  background: #eff6ff;
  color: #2563eb;
}

.user-card-footer {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 8px;
  padding: 12px 20px;
  background: #f8fafc;
  border-top: 1px solid #e5e7eb;
}

.user-action-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.user-action-btn.edit {
  background: #eff6ff;
  color: #3b82f6;
}

.user-action-btn.edit:hover {
  background: #3b82f6;
  color: white;
}

.user-action-btn.delete {
  background: #fef2f2;
  color: #ef4444;
}

.user-action-btn.delete:hover {
  background: #ef4444;
  color: white;
}

.user-action-btn.password {
  background: #f0fdf4;
  color: #22c55e;
}

.user-action-btn.password:hover {
  background: #22c55e;
  color: white;
}
</style>


<style>
/* Modal Styles */
.users-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(15, 23, 42, 0.6);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.users-modal-overlay.open {
  opacity: 1;
  visibility: visible;
}

.users-modal {
  background: white;
  border-radius: 20px;
  width: 100%;
  max-width: 520px;
  max-height: 90vh;
  overflow: hidden;
  box-shadow: 0 25px 50px rgba(0,0,0,0.25);
  transform: scale(0.9) translateY(20px);
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.users-modal-overlay.open .users-modal {
  transform: scale(1) translateY(0);
}

.users-modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 24px;
  background: linear-gradient(135deg, #FF6B00 0%, #ff8534 100%);
  color: white;
}

.users-modal-title {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 1.25rem;
  font-weight: 700;
}

.users-modal-title i {
  font-size: 1.1rem;
}

.users-modal-close {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  background: rgba(255,255,255,0.2);
  border: none;
  border-radius: 10px;
  color: white;
  cursor: pointer;
  transition: all 0.2s ease;
}

.users-modal-close:hover {
  background: rgba(255,255,255,0.3);
}

.users-modal-body {
  padding: 24px;
  max-height: calc(90vh - 180px);
  overflow-y: auto;
}

.users-form-group {
  margin-bottom: 20px;
}

.users-form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.users-label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.85rem;
  font-weight: 600;
  color: #475569;
  margin-bottom: 8px;
}

.users-label i {
  color: #FF6B00;
  font-size: 0.9rem;
}

.users-label .required {
  color: #ef4444;
}

.users-input,
.users-select {
  width: 100%;
  padding: 12px 16px;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 10px;
  font-size: 0.95rem;
  color: #1e293b;
  outline: none;
  transition: all 0.2s ease;
}

.users-input:focus,
.users-select:focus {
  background: white;
  border-color: #FF6B00;
  box-shadow: 0 0 0 3px rgba(255,107,0,0.1);
}

.users-input::placeholder {
  color: #94a3b8;
}

.users-password-wrapper {
  position: relative;
}

.users-password-wrapper input {
  padding-right: 48px;
}

.users-password-toggle {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: #94a3b8;
  cursor: pointer;
  padding: 4px;
  transition: color 0.2s ease;
}

.users-password-toggle:hover {
  color: #FF6B00;
}

.users-helper {
  display: block;
  font-size: 0.8rem;
  color: #94a3b8;
  margin-top: 6px;
}

.users-toggle-wrapper {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 0;
}

.users-toggle {
  position: relative;
  width: 48px;
  height: 26px;
}

.users-toggle input {
  opacity: 0;
  width: 0;
  height: 0;
}

.users-toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: #cbd5e1;
  border-radius: 50px;
  transition: all 0.3s ease;
}

.users-toggle-slider::before {
  content: '';
  position: absolute;
  height: 20px;
  width: 20px;
  left: 3px;
  bottom: 3px;
  background: white;
  border-radius: 50%;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.users-toggle input:checked + .users-toggle-slider {
  background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
}

.users-toggle input:checked + .users-toggle-slider::before {
  transform: translateX(22px);
}

.users-toggle-label {
  font-size: 0.9rem;
  font-weight: 500;
  color: #475569;
}

.users-modal-footer {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 12px;
  padding: 16px 24px;
  background: #f8fafc;
  border-top: 1px solid #e5e7eb;
}

.users-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 20px;
  border: none;
  border-radius: 10px;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.users-btn-secondary {
  background: white;
  color: #64748b;
  border: 1px solid #e2e8f0;
}

.users-btn-secondary:hover {
  background: #f1f5f9;
  border-color: #cbd5e1;
}

.users-btn-primary {
  background: linear-gradient(135deg, #FF6B00 0%, #ff8534 100%);
  color: white;
  box-shadow: 0 4px 12px rgba(255,107,0,0.3);
}

.users-btn-primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 16px rgba(255,107,0,0.4);
}

.users-btn-primary:disabled {
  opacity: 0.7;
  cursor: not-allowed;
  transform: none;
}

/* Responsive */
@media (max-width: 768px) {
  .users-toolbar {
    flex-direction: column;
    align-items: stretch;
  }
  
  .users-search {
    max-width: none;
  }
  
  .users-filters {
    flex-wrap: wrap;
  }
  
  .users-grid {
    grid-template-columns: 1fr;
  }
  
  .users-form-row {
    grid-template-columns: 1fr;
  }
  
  .users-modal {
    margin: 16px;
    max-width: calc(100% - 32px);
  }
}
</style>


<script>
// ==================== USERS MODULE ==================== 

var UsersModule = {
  usersData: [],
  rolesData: [],
  isEditing: false,
  
  // Inicializar
  init: function() {
    console.log('UsersModule: Inicializando...');
    this.loadRoles();
    this.loadUsers();
    
    // Listener para el toggle de activo
    var activeCheckbox = document.getElementById('userActive');
    if (activeCheckbox) {
      activeCheckbox.addEventListener('change', function() {
        var label = document.getElementById('userActiveLabel');
        if (label) label.textContent = this.checked ? 'Activo' : 'Inactivo';
      });
    }
  },
  
  // Cargar roles disponibles
  loadRoles: function() {
    var self = this;
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          self.rolesData = result.roles || [];
          self.populateRoleSelects();
        }
      })
      .withFailureHandler(function(error) {
        console.error('Error cargando roles:', error);
      })
      .getAllRoles();
  },
  
  // Poblar selectores de roles
  populateRoleSelects: function() {
    var roleSelect = document.getElementById('userRole');
    var roleFilter = document.getElementById('usersRoleFilter');
    
    if (roleSelect) {
      roleSelect.innerHTML = '<option value="">Seleccionar rol...</option>';
      this.rolesData.forEach(function(role) {
        var icon = role.nombre.toUpperCase().includes('ADMIN') ? '游녬' : 
                   role.nombre.toUpperCase().includes('SUPERVISOR') ? '游녮' : '游댢';
        roleSelect.innerHTML += '<option value="' + role.nombre + '">' + icon + ' ' + role.nombre + '</option>';
      });
    }
    
    if (roleFilter) {
      roleFilter.innerHTML = '<option value="">Todos los roles</option>';
      this.rolesData.forEach(function(role) {
        roleFilter.innerHTML += '<option value="' + role.nombre + '">' + role.nombre + '</option>';
      });
    }
  },
  
  // Cargar usuarios
  loadUsers: function() {
    var self = this;
    var grid = document.getElementById('usersGrid');
    
    grid.innerHTML = '<div class="users-loading"><i class="fas fa-spinner fa-spin"></i><span>Cargando usuarios...</span></div>';
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          self.usersData = result.users || [];
          self.render();
          self.updateStats();
        } else {
          grid.innerHTML = '<div class="users-empty"><i class="fas fa-exclamation-triangle" style="color:#ef4444;"></i><p>Error: ' + (result.error || 'No se pudieron cargar los usuarios') + '</p></div>';
        }
      })
      .withFailureHandler(function(error) {
        grid.innerHTML = '<div class="users-empty"><i class="fas fa-wifi-slash" style="color:#ef4444;"></i><p>Error de conexi칩n</p></div>';
      })
      .getUsers();
  },
  
  // Renderizar usuarios
  render: function() {
    var self = this;
    var grid = document.getElementById('usersGrid');
    
    if (!this.usersData.length) {
      grid.innerHTML = '<div class="users-empty"><i class="fas fa-users"></i><p>No hay usuarios registrados</p><button class="users-btn users-btn-primary" onclick="UsersModule.openModal()"><i class="fas fa-user-plus"></i> Crear primer usuario</button></div>';
      return;
    }
    
    var html = this.usersData.map(function(user) {
      return self.renderUserCard(user);
    }).join('');
    
    grid.innerHTML = html;
  },
  
  // Renderizar tarjeta de usuario
  renderUserCard: function(user) {
    var avatarClass = this.getAvatarClass(user.rol);
    var initial = user.nombre ? user.nombre.charAt(0).toUpperCase() : '?';
    var isActive = user.activo !== false && user.activo !== 'NO';
    var roleBadgeClass = this.getRoleBadgeClass(user.rol);
    var roleIcon = this.getRoleIcon(user.rol);
    
    return '<div class="user-card" data-user-id="' + user.id + '">' +
           '<div class="user-card-header">' +
           '<div class="user-avatar ' + avatarClass + '">' + initial + '</div>' +
           '<div class="user-info">' +
           '<h3>' + (user.nombre || 'Sin nombre') + '</h3>' +
           '<p>' + (user.email || 'Sin email') + '</p>' +
           '</div>' +
           '<span class="user-status ' + (isActive ? 'active' : 'inactive') + '">' + (isActive ? 'Activo' : 'Inactivo') + '</span>' +
           '</div>' +
           '<div class="user-card-body">' +
           '<div class="user-detail">' +
           '<i class="fas fa-user-tag"></i>' +
           '<span class="user-role-badge ' + roleBadgeClass + '">' + roleIcon + ' ' + (user.rol || 'Sin rol') + '</span>' +
           '</div>' +
           '<div class="user-detail">' +
           '<i class="fas fa-calendar-alt"></i>' +
           '<span>Creado: ' + this.formatDate(user.fechaCreacion) + '</span>' +
           '</div>' +
           '</div>' +
           '<div class="user-card-footer">' +
           '<button class="user-action-btn password" onclick="UsersModule.resetPassword(\'' + user.id + '\', \'' + this.escapeHtml(user.nombre) + '\')" title="Restablecer contrase침a">' +
           '<i class="fas fa-key"></i>' +
           '</button>' +
           '<button class="user-action-btn edit" onclick="UsersModule.editUser(\'' + user.id + '\')" title="Editar usuario">' +
           '<i class="fas fa-edit"></i>' +
           '</button>' +
           '<button class="user-action-btn delete" onclick="UsersModule.deleteUser(\'' + user.id + '\', \'' + this.escapeHtml(user.nombre) + '\')" title="Eliminar usuario">' +
           '<i class="fas fa-trash"></i>' +
           '</button>' +
           '</div>' +
           '</div>';
  },
  
  // Filtrar usuarios
  filterUsers: function() {
    var search = (document.getElementById('usersSearchInput').value || '').toLowerCase();
    var roleFilter = document.getElementById('usersRoleFilter').value;
    var statusFilter = document.getElementById('usersStatusFilter').value;
    
    var filtered = this.usersData.filter(function(user) {
      var matchSearch = !search || 
        (user.nombre || '').toLowerCase().includes(search) ||
        (user.email || '').toLowerCase().includes(search) ||
        (user.rol || '').toLowerCase().includes(search);
      
      var matchRole = !roleFilter || user.rol === roleFilter;
      
      var isActive = user.activo !== false && user.activo !== 'NO';
      var matchStatus = !statusFilter || 
        (statusFilter === 'active' && isActive) ||
        (statusFilter === 'inactive' && !isActive);
      
      return matchSearch && matchRole && matchStatus;
    });
    
    var grid = document.getElementById('usersGrid');
    if (filtered.length === 0) {
      grid.innerHTML = '<div class="users-empty"><i class="fas fa-search"></i><p>No se encontraron usuarios</p></div>';
    } else {
      var self = this;
      grid.innerHTML = filtered.map(function(user) {
        return self.renderUserCard(user);
      }).join('');
    }
  },
  
  // Actualizar estad칤sticas
  updateStats: function() {
    var total = this.usersData.length;
    var active = this.usersData.filter(function(u) { return u.activo !== false && u.activo !== 'NO'; }).length;
    var admins = this.usersData.filter(function(u) { return (u.rol || '').toUpperCase() === 'ADMIN'; }).length;
    var supervisors = this.usersData.filter(function(u) { return (u.rol || '').toUpperCase() === 'SUPERVISOR'; }).length;
    
    var el1 = document.getElementById('statUsersTotal');
    var el2 = document.getElementById('statUsersActive');
    var el3 = document.getElementById('statUsersAdmin');
    var el4 = document.getElementById('statUsersSupervisor');
    
    if (el1) el1.textContent = total;
    if (el2) el2.textContent = active;
    if (el3) el3.textContent = admins;
    if (el4) el4.textContent = supervisors;
  },
  
  // Abrir modal
  openModal: function() {
    this.isEditing = false;
    document.getElementById('userId').value = '';
    document.getElementById('userName').value = '';
    document.getElementById('userEmail').value = '';
    document.getElementById('userPassword').value = '';
    document.getElementById('userRole').value = '';
    document.getElementById('userActive').checked = true;
    document.getElementById('userActiveLabel').textContent = 'Activo';
    
    document.getElementById('modalIcon').className = 'fas fa-user-plus';
    document.getElementById('modalTitle').textContent = 'Nuevo Usuario';
    document.getElementById('passwordRequired').style.display = 'inline';
    document.getElementById('passwordHelper').textContent = 'M칤nimo 6 caracteres';
    document.getElementById('userPassword').required = true;
    
    document.getElementById('userModal').classList.add('open');
    setTimeout(function() {
      document.getElementById('userName').focus();
    }, 300);
  },
  
  // Cerrar modal
  closeModal: function() {
    document.getElementById('userModal').classList.remove('open');
  },
  
  // Editar usuario
  editUser: function(userId) {
    var user = this.usersData.find(function(u) { return u.id === userId; });
    if (!user) return;
    
    this.isEditing = true;
    document.getElementById('userId').value = user.id;
    document.getElementById('userName').value = user.nombre || '';
    document.getElementById('userEmail').value = user.email || '';
    document.getElementById('userPassword').value = '';
    document.getElementById('userRole').value = user.rol || '';
    
    var isActive = user.activo !== false && user.activo !== 'NO';
    document.getElementById('userActive').checked = isActive;
    document.getElementById('userActiveLabel').textContent = isActive ? 'Activo' : 'Inactivo';
    
    document.getElementById('modalIcon').className = 'fas fa-user-edit';
    document.getElementById('modalTitle').textContent = 'Editar Usuario';
    document.getElementById('passwordRequired').style.display = 'none';
    document.getElementById('passwordHelper').textContent = 'Dejar vac칤o para mantener la contrase침a actual';
    document.getElementById('userPassword').required = false;
    
    document.getElementById('userModal').classList.add('open');
  },
  
  // Guardar usuario
  saveUser: function(e) {
    e.preventDefault();
    
    var self = this;
    var btn = document.getElementById('btnSaveUser');
    var originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
    btn.disabled = true;
    
    var userData = {
      id: document.getElementById('userId').value || null,
      nombre: document.getElementById('userName').value.trim(),
      email: document.getElementById('userEmail').value.trim(),
      password: document.getElementById('userPassword').value,
      rol: document.getElementById('userRole').value,
      activo: document.getElementById('userActive').checked
    };
    
    // Validar contrase침a para nuevos usuarios
    if (!userData.id && (!userData.password || userData.password.length < 6)) {
      btn.innerHTML = originalHtml;
      btn.disabled = false;
      if (window.WMSToast) WMSToast.error('La contrase침a es requerida (m칤nimo 6 caracteres)');
      return;
    }
    
    google.script.run
      .withSuccessHandler(function(result) {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
        
        if (result.success) {
          if (window.WMSToast) WMSToast.success(self.isEditing ? 'Usuario actualizado correctamente' : 'Usuario creado correctamente');
          self.closeModal();
          self.loadUsers();
        } else {
          if (window.WMSToast) WMSToast.error('Error: ' + result.error);
        }
      })
      .withFailureHandler(function(error) {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
        if (window.WMSToast) WMSToast.error('Error: ' + error.message);
      })
      .saveUser(userData);
  },
  
  // Eliminar usuario
  deleteUser: function(userId, userName) {
    if (!confirm('쮼st치s seguro de eliminar al usuario "' + userName + '"?\n\nEsta acci칩n no se puede deshacer.')) return;
    
    var self = this;
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          if (window.WMSToast) WMSToast.success('Usuario eliminado correctamente');
          self.loadUsers();
        } else {
          if (window.WMSToast) WMSToast.error('Error: ' + result.error);
        }
      })
      .withFailureHandler(function(error) {
        if (window.WMSToast) WMSToast.error('Error: ' + error.message);
      })
      .deleteUser(userId);
  },
  
  // Restablecer contrase침a
  resetPassword: function(userId, userName) {
    var newPassword = prompt('Nueva contrase침a para "' + userName + '":\n(M칤nimo 6 caracteres)');
    
    if (!newPassword) return;
    
    if (newPassword.length < 6) {
      if (window.WMSToast) WMSToast.error('La contrase침a debe tener al menos 6 caracteres');
      return;
    }
    
    var self = this;
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          if (window.WMSToast) WMSToast.success('Contrase침a actualizada correctamente');
        } else {
          if (window.WMSToast) WMSToast.error('Error: ' + result.error);
        }
      })
      .withFailureHandler(function(error) {
        if (window.WMSToast) WMSToast.error('Error: ' + error.message);
      })
      .updateUser(userId, { password: newPassword });
  },
  
  // Toggle visibilidad de contrase침a
  togglePassword: function() {
    var input = document.getElementById('userPassword');
    var icon = document.getElementById('passwordToggleIcon');
    
    if (input.type === 'password') {
      input.type = 'text';
      icon.className = 'fas fa-eye-slash';
    } else {
      input.type = 'password';
      icon.className = 'fas fa-eye';
    }
  },
  
  // Helpers
  getAvatarClass: function(rol) {
    if (!rol) return 'default';
    var r = rol.toUpperCase();
    if (r.includes('ADMIN')) return 'admin';
    if (r.includes('SUPERVISOR')) return 'supervisor';
    if (r.includes('OPERADOR')) return 'operador';
    return 'default';
  },
  
  getRoleBadgeClass: function(rol) {
    if (!rol) return 'default';
    var r = rol.toUpperCase();
    if (r.includes('ADMIN')) return 'admin';
    if (r.includes('SUPERVISOR')) return 'supervisor';
    if (r.includes('OPERADOR')) return 'operador';
    return 'default';
  },
  
  getRoleIcon: function(rol) {
    if (!rol) return '游녻';
    var r = rol.toUpperCase();
    if (r.includes('ADMIN')) return '游녬';
    if (r.includes('SUPERVISOR')) return '游녮';
    if (r.includes('OPERADOR')) return '游댢';
    return '游녻';
  },
  
  formatDate: function(dateStr) {
    if (!dateStr) return 'N/A';
    try {
      var date = new Date(dateStr);
      return date.toLocaleDateString('es-CL');
    } catch (e) {
      return dateStr;
    }
  },
  
  escapeHtml: function(str) {
    if (!str) return '';
    return String(str).replace(/[&<>"']/g, function(m) {
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
    });
  }
};

// Funciones globales
function initUsersModule() { UsersModule.init(); }
function loadUsers() { UsersModule.loadUsers(); }

window.UsersModule = UsersModule;
window.initUsersModule = initUsersModule;
window.loadUsers = loadUsers;
</script>
</section>
