<section class="view" id="dashboardView">
<!-- Dashboard_Unified.html - Dashboard Principal Unificado con WMS Design System -->

<style>
/* Variables locales para Dashboard - Mapeo a WMS Design System */
#dashboardView {
  --spacing-xs: var(--wms-space-1, 0.25rem);
  --spacing-sm: var(--wms-space-2, 0.5rem);
  --spacing-md: var(--wms-space-4, 1rem);
  --spacing-lg: var(--wms-space-6, 1.5rem);
  --spacing-xl: var(--wms-space-8, 2rem);
  --radius-md: var(--wms-radius-md, 8px);
  --radius-lg: var(--wms-radius-lg, 12px);
  --radius-full: var(--wms-radius-full, 9999px);
  --border-color: var(--wms-border-default, #e2e8f0);
  --shadow-lg: var(--wms-shadow-lg);
  --transition-fast: var(--wms-transition-fast, 150ms ease);
  --transition-normal: var(--wms-transition-base, 200ms ease);
  --font-size-xs: var(--wms-text-xs, 0.75rem);
  --font-size-sm: var(--wms-text-sm, 0.875rem);
  --font-size-lg: var(--wms-text-lg, 1.125rem);
  --font-size-xl: var(--wms-text-xl, 1.25rem);
  --text-primary: var(--wms-text-primary, #0f172a);
  --text-secondary: var(--wms-text-secondary, #64748b);
  --text-muted: var(--wms-text-tertiary, #94a3b8);
  --neutral-50: var(--wms-gray-50, #f8fafc);
  --neutral-100: var(--wms-gray-100, #f1f5f9);
  --neutral-200: var(--wms-gray-200, #e2e8f0);
  --neutral-300: var(--wms-gray-300, #cbd5e1);
  --neutral-500: var(--wms-gray-500, #64748b);
  --primary: var(--wms-primary, #FF6B00);
  --info: var(--wms-info, #06b6d4);
  --info-light: var(--wms-info-light, #ECFEFF);
  --success: var(--wms-success, #10b981);
  --success-light: var(--wms-success-light, #ECFDF5);
  --warning: var(--wms-warning, #f59e0b);
  --warning-light: var(--wms-warning-light, #FFFBEB);
  --danger: var(--wms-danger, #ef4444);
  --danger-light: var(--wms-danger-light, #FEF2F2);
}
</style>

<div class="wms-page-container">
  <!-- Module Header Premium -->
  <div class="wms-module-header wms-module-header-premium">
    <div class="wms-breadcrumb">
      <a href="#" onclick="showView('homeView'); return false;">
        <i class="fas fa-home"></i> Inicio
      </a>
      <i class="fas fa-chevron-right"></i>
      <span>Dashboard</span>
    </div>
    
    <div class="wms-header-content">
      <div class="wms-header-icon">
        <i class="fas fa-chart-line"></i>
      </div>
      <div class="wms-header-text">
        <h1 class="wms-module-title">Dashboard</h1>
        <p class="wms-module-subtitle">Monitoreo en tiempo real del sistema logístico</p>
      </div>
    </div>
    
    <div class="wms-quick-actions">
      <button class="wms-btn wms-btn-premium" onclick="loadDashboardDataUnified()" aria-label="Actualizar datos">
        <i class="fas fa-sync-alt"></i>
        <span>Actualizar</span>
      </button>
      <div class="wms-connection-status online" id="dashboardConnectionStatus">
        <i class="fas fa-wifi"></i>
        <span id="dashboardLastUpdate">Última actualización: --:--</span>
      </div>
    </div>
  </div>

  <!-- KPIs Stats Grid Premium -->
  <div class="wms-stats-grid wms-stats-4">
    <div class="wms-stat-card wms-stat-card-premium clickable" onclick="filterDashboardByStatus('all')" data-color="info">
      <div class="wms-stat-icon">
        <i class="fas fa-shopping-cart"></i>
      </div>
      <div class="wms-stat-content">
        <span class="wms-stat-value" id="dashboardTotalOrders">0</span>
        <span class="wms-stat-label">Órdenes Hoy</span>
      </div>
      <div class="wms-stat-trend up" id="dashboardOrdersTrend">
        <i class="fas fa-arrow-up"></i>
        <span>--</span>
      </div>
    </div>
    
    <div class="wms-stat-card wms-stat-card-premium clickable" onclick="filterDashboardByStatus('cumplimiento')" data-color="success">
      <div class="wms-stat-icon">
        <i class="fas fa-percentage"></i>
      </div>
      <div class="wms-stat-content">
        <span class="wms-stat-value" id="dashboardCumplimiento">0%</span>
        <span class="wms-stat-label">Cumplimiento</span>
      </div>
      <div class="wms-stat-trend" id="dashboardCumplimientoTrend">
        <i class="fas fa-minus"></i>
        <span>--</span>
      </div>
    </div>
    
    <div class="wms-stat-card wms-stat-card-premium clickable" onclick="filterDashboardByStatus('tiempo')" data-color="warning">
      <div class="wms-stat-icon">
        <i class="fas fa-clock"></i>
      </div>
      <div class="wms-stat-content">
        <span class="wms-stat-value" id="dashboardTiempoPromedio">0m</span>
        <span class="wms-stat-label">Tiempo Promedio</span>
      </div>
      <div class="wms-stat-trend" id="dashboardTiempoTrend">
        <i class="fas fa-minus"></i>
        <span>--</span>
      </div>
    </div>
    
    <div class="wms-stat-card wms-stat-card-premium clickable" onclick="filterDashboardByStatus('productividad')" data-color="purple">
      <div class="wms-stat-icon">
        <i class="fas fa-tachometer-alt"></i>
      </div>
      <div class="wms-stat-content">
        <span class="wms-stat-value" id="dashboardProductividad">0</span>
        <span class="wms-stat-label">Productividad/Hora</span>
      </div>
      <div class="wms-stat-trend" id="dashboardProductividadTrend">
        <i class="fas fa-minus"></i>
        <span>--</span>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="dashboard-content-grid">
    <!-- Gráfico de Órdenes -->
    <div class="wms-card chart-section">
      <div class="wms-card-header">
        <h3><i class="fas fa-chart-pie"></i> Órdenes por Estado</h3>
        <div class="wms-card-actions">
          <select class="wms-select-sm" id="dashboardChartPeriod" onchange="updateChartPeriod(this.value)">
            <option value="today">Hoy</option>
            <option value="week">Esta Semana</option>
            <option value="month">Este Mes</option>
          </select>
        </div>
      </div>
      <div class="wms-card-body">
        <div class="chart-container">
          <canvas id="dashboardOrdersChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Pipeline de Proceso -->
    <div class="wms-card pipeline-section">
      <div class="wms-card-header">
        <h3><i class="fas fa-stream"></i> Pipeline de Proceso</h3>
      </div>
      <div class="wms-card-body">
        <div class="wms-timeline horizontal">
          <div class="wms-timeline-item" onclick="showView('ordersView')">
            <div class="wms-timeline-node pending">
              <i class="fas fa-inbox"></i>
            </div>
            <div class="wms-timeline-content">
              <span class="wms-timeline-value" id="dashboardStageCreadas">0</span>
              <span class="wms-timeline-label">Creadas</span>
            </div>
          </div>
          
          <div class="wms-timeline-connector"></div>
          
          <div class="wms-timeline-item" onclick="showView('pickingView')">
            <div class="wms-timeline-node current">
              <i class="fas fa-hand-pointer"></i>
            </div>
            <div class="wms-timeline-content">
              <span class="wms-timeline-value" id="dashboardStagePicking">0</span>
              <span class="wms-timeline-label">Picking</span>
            </div>
          </div>
          
          <div class="wms-timeline-connector"></div>
          
          <div class="wms-timeline-item" onclick="showView('packingView')">
            <div class="wms-timeline-node pending">
              <i class="fas fa-box"></i>
            </div>
            <div class="wms-timeline-content">
              <span class="wms-timeline-value" id="dashboardStagePacking">0</span>
              <span class="wms-timeline-label">Packing</span>
            </div>
          </div>
          
          <div class="wms-timeline-connector"></div>
          
          <div class="wms-timeline-item" onclick="showView('dispatchView')">
            <div class="wms-timeline-node pending">
              <i class="fas fa-shipping-fast"></i>
            </div>
            <div class="wms-timeline-content">
              <span class="wms-timeline-value" id="dashboardStageDespachadas">0</span>
              <span class="wms-timeline-label">Despachadas</span>
            </div>
          </div>
          
          <div class="wms-timeline-connector"></div>
          
          <div class="wms-timeline-item" onclick="showView('deliveryView')">
            <div class="wms-timeline-node completed">
              <i class="fas fa-check-double"></i>
            </div>
            <div class="wms-timeline-content">
              <span class="wms-timeline-value" id="dashboardStageEntregadas">0</span>
              <span class="wms-timeline-label">Entregadas</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Alertas -->
    <div class="wms-card alerts-section">
      <div class="wms-card-header">
        <h3><i class="fas fa-bell"></i> Alertas</h3>
        <span class="wms-badge wms-badge-danger" id="dashboardAlertCount">0</span>
      </div>
      <div class="wms-card-body">
        <div class="wms-alerts-list" id="dashboardAlertsList">
          <div class="wms-empty-state small">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Cargando alertas...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Ranking de Operadores -->
    <div class="wms-card ranking-section">
      <div class="wms-card-header">
        <h3><i class="fas fa-trophy"></i> Top Operadores</h3>
        <span class="wms-badge wms-badge-info">Hoy</span>
      </div>
      <div class="wms-card-body">
        <div class="wms-ranking-list" id="dashboardRankingList">
          <div class="wms-empty-state small">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Cargando ranking...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Actividad Reciente -->
    <div class="wms-card activity-section">
      <div class="wms-card-header">
        <h3><i class="fas fa-history"></i> Actividad Reciente</h3>
        <button class="wms-btn wms-btn-ghost wms-btn-sm" onclick="showAllActivity()">
          Ver todo
        </button>
      </div>
      <div class="wms-card-body">
        <div class="wms-activity-list" id="dashboardActivityList">
          <div class="wms-empty-state small">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Cargando actividad...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtro de Fechas Mejorado -->
  <div class="wms-date-filter-bar" id="dashboardDateFilter" style="display: none;">
    <div class="wms-date-filter-content">
      <label>Filtrar por fecha:</label>
      <div class="wms-date-inputs">
        <input type="date" class="wms-input" id="dashboardDateFrom" onchange="applyDateFilter()">
        <span>a</span>
        <input type="date" class="wms-input" id="dashboardDateTo" onchange="applyDateFilter()">
      </div>
      <div class="wms-date-presets">
        <button class="wms-btn wms-btn-ghost wms-btn-sm" onclick="setDatePreset('today')">Hoy</button>
        <button class="wms-btn wms-btn-ghost wms-btn-sm" onclick="setDatePreset('week')">Esta Semana</button>
        <button class="wms-btn wms-btn-ghost wms-btn-sm" onclick="setDatePreset('month')">Este Mes</button>
      </div>
      <button class="wms-btn wms-btn-secondary wms-btn-sm" onclick="closeDateFilter()">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>
</div>

<style>
/* Dashboard Specific Styles using WMS Design System */
/* SCOPED: Todos los estilos están prefijados con #dashboardView para evitar conflictos */

#dashboardView .dashboard-content-grid {
  display: grid;
  grid-template-columns: 2fr 1fr;
  grid-template-rows: auto auto auto;
  gap: var(--spacing-lg);
  margin-top: var(--spacing-lg);
}

/* Grid Placement */
#dashboardView .chart-section { grid-column: 1; grid-row: 1; }
#dashboardView .alerts-section { grid-column: 2; grid-row: 1; }
#dashboardView .pipeline-section { grid-column: 1 / -1; grid-row: 2; }
#dashboardView .ranking-section { grid-column: 1; grid-row: 3; }
#dashboardView .activity-section { grid-column: 2; grid-row: 3; }

/* Chart Container */
#dashboardView .chart-container {
  height: 280px;
  position: relative;
}

/* Card Actions */
#dashboardView .wms-card-actions {
  display: flex;
  gap: var(--spacing-sm);
  align-items: center;
}

#dashboardView .wms-select-sm {
  padding: var(--spacing-xs) var(--spacing-sm);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  font-size: var(--font-size-sm);
  background: white;
  cursor: pointer;
}

/* Horizontal Timeline for Pipeline */
#dashboardView .wms-timeline.horizontal {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  padding: var(--spacing-md) 0;
}

#dashboardView .wms-timeline.horizontal .wms-timeline-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--spacing-sm);
  flex: 1;
  cursor: pointer;
  transition: transform var(--transition-fast);
}

#dashboardView .wms-timeline.horizontal .wms-timeline-item:hover {
  transform: translateY(-2px);
}

#dashboardView .wms-timeline.horizontal .wms-timeline-node {
  width: 56px;
  height: 56px;
  border-radius: var(--radius-lg);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  transition: all var(--transition-normal);
}

#dashboardView .wms-timeline.horizontal .wms-timeline-node.pending {
  background: var(--neutral-100);
  color: var(--neutral-500);
  border: 2px dashed var(--neutral-300);
}

#dashboardView .wms-timeline.horizontal .wms-timeline-node.current {
  background: var(--info-light);
  color: var(--info);
  border: 2px solid var(--info);
  animation: pulse 2s infinite;
}

#dashboardView .wms-timeline.horizontal .wms-timeline-node.completed {
  background: var(--success-light);
  color: var(--success);
  border: 2px solid var(--success);
}

#dashboardView .wms-timeline.horizontal .wms-timeline-content {
  text-align: center;
}

#dashboardView .wms-timeline-value {
  display: block;
  font-size: var(--font-size-xl);
  font-weight: 700;
  color: var(--text-primary);
}

#dashboardView .wms-timeline-label {
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
}

#dashboardView .wms-timeline-connector {
  flex: 0 0 auto;
  width: 40px;
  height: 2px;
  background: linear-gradient(90deg, var(--neutral-300), var(--neutral-200));
  margin-top: 28px;
}

/* Alerts List */
#dashboardView .wms-alerts-list {
  max-height: 280px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: var(--spacing-sm);
}

#dashboardView .wms-alert-item {
  display: flex;
  gap: var(--spacing-md);
  padding: var(--spacing-md);
  background: var(--neutral-50);
  border-radius: var(--radius-md);
  border-left: 3px solid var(--info);
  transition: all var(--transition-fast);
}

#dashboardView .wms-alert-item:hover {
  background: var(--neutral-100);
}

#dashboardView .wms-alert-item.danger { border-left-color: var(--danger); }
#dashboardView .wms-alert-item.warning { border-left-color: var(--warning); }
#dashboardView .wms-alert-item.success { border-left-color: var(--success); }

#dashboardView .wms-alert-icon {
  width: 36px;
  height: 36px;
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

#dashboardView .wms-alert-item.danger .wms-alert-icon { background: var(--danger-light); color: var(--danger); }
#dashboardView .wms-alert-item.warning .wms-alert-icon { background: var(--warning-light); color: var(--warning); }
#dashboardView .wms-alert-item.success .wms-alert-icon { background: var(--success-light); color: var(--success); }
#dashboardView .wms-alert-item .wms-alert-icon { background: var(--info-light); color: var(--info); }

#dashboardView .wms-alert-content {
  flex: 1;
  min-width: 0;
}

#dashboardView .wms-alert-title {
  font-weight: 600;
  font-size: var(--font-size-sm);
  color: var(--text-primary);
  margin-bottom: var(--spacing-xs);
}

#dashboardView .wms-alert-desc {
  font-size: var(--font-size-xs);
  color: var(--text-secondary);
  line-height: 1.4;
}

/* Ranking List */
#dashboardView .wms-ranking-list {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-sm);
}

#dashboardView .wms-ranking-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  padding: var(--spacing-md);
  background: var(--neutral-50);
  border-radius: var(--radius-md);
  transition: all var(--transition-fast);
}

#dashboardView .wms-ranking-item:hover {
  background: var(--neutral-100);
}

#dashboardView .wms-ranking-position {
  width: 32px;
  height: 32px;
  border-radius: var(--radius-full);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: var(--font-size-sm);
}

#dashboardView .wms-ranking-item:nth-child(1) .wms-ranking-position {
  background: linear-gradient(135deg, #ffd700, #ffb800);
  color: white;
}

#dashboardView .wms-ranking-item:nth-child(2) .wms-ranking-position {
  background: linear-gradient(135deg, #c0c0c0, #a8a8a8);
  color: white;
}

#dashboardView .wms-ranking-item:nth-child(3) .wms-ranking-position {
  background: linear-gradient(135deg, #cd7f32, #b87333);
  color: white;
}

#dashboardView .wms-ranking-item:nth-child(n+4) .wms-ranking-position {
  background: var(--neutral-200);
  color: var(--text-secondary);
}

#dashboardView .wms-ranking-info {
  flex: 1;
}

#dashboardView .wms-ranking-name {
  font-weight: 600;
  font-size: var(--font-size-sm);
  color: var(--text-primary);
}

#dashboardView .wms-ranking-stats {
  font-size: var(--font-size-xs);
  color: var(--text-secondary);
}

#dashboardView .wms-ranking-score {
  font-weight: 700;
  font-size: var(--font-size-lg);
  color: var(--primary);
}

/* Activity List */
#dashboardView .wms-activity-list {
  max-height: 280px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: var(--spacing-sm);
}

#dashboardView .wms-activity-item {
  display: flex;
  gap: var(--spacing-md);
  padding: var(--spacing-md);
  background: var(--neutral-50);
  border-radius: var(--radius-md);
  transition: all var(--transition-fast);
}

#dashboardView .wms-activity-item:hover {
  background: var(--neutral-100);
}

#dashboardView .wms-activity-icon {
  width: 36px;
  height: 36px;
  border-radius: var(--radius-full);
  background: var(--neutral-200);
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

#dashboardView .wms-activity-content {
  flex: 1;
  min-width: 0;
}

#dashboardView .wms-activity-title {
  font-weight: 600;
  font-size: var(--font-size-sm);
  color: var(--text-primary);
}

#dashboardView .wms-activity-desc {
  font-size: var(--font-size-xs);
  color: var(--text-secondary);
  margin-top: var(--spacing-xs);
}

#dashboardView .wms-activity-time {
  font-size: var(--font-size-xs);
  color: var(--text-muted);
  margin-top: var(--spacing-xs);
}

/* Date Filter Bar */
#dashboardView .wms-date-filter-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  border-top: 1px solid var(--border-color);
  box-shadow: var(--shadow-lg);
  padding: var(--spacing-md) var(--spacing-lg);
  z-index: 100;
  animation: slideUp var(--transition-normal);
}

@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}

#dashboardView .wms-date-filter-content {
  display: flex;
  align-items: center;
  gap: var(--spacing-lg);
  max-width: 1200px;
  margin: 0 auto;
}

#dashboardView .wms-date-inputs {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

#dashboardView .wms-date-presets {
  display: flex;
  gap: var(--spacing-xs);
}

/* Empty State Small */
#dashboardView .wms-empty-state.small {
  padding: var(--spacing-xl);
  text-align: center;
  color: var(--text-secondary);
}

#dashboardView .wms-empty-state.small i {
  font-size: 1.5rem;
  margin-bottom: var(--spacing-sm);
  display: block;
}

#dashboardView .wms-empty-state.small p {
  margin: 0;
  font-size: var(--font-size-sm);
}

/* Stat Card Purple Type */
#dashboardView .wms-stat-card[data-type="purple"] .wms-stat-icon {
  background: rgba(139, 92, 246, 0.1);
  color: #8b5cf6;
}

/* Responsive */
@media (max-width: 1200px) {
  #dashboardView .dashboard-content-grid {
    grid-template-columns: 1fr 1fr;
  }
  
  #dashboardView .pipeline-section { grid-column: 1 / -1; }
  #dashboardView .activity-section { grid-column: 1 / -1; }
}

@media (max-width: 768px) {
  #dashboardView .dashboard-content-grid {
    grid-template-columns: 1fr;
  }
  
  #dashboardView .chart-section,
  #dashboardView .alerts-section,
  #dashboardView .pipeline-section,
  #dashboardView .ranking-section,
  #dashboardView .activity-section {
    grid-column: 1;
    grid-row: auto;
  }
  
  #dashboardView .wms-timeline.horizontal {
    flex-wrap: wrap;
    gap: var(--spacing-lg);
    justify-content: center;
  }
  
  #dashboardView .wms-timeline-connector {
    display: none;
  }
  
  #dashboardView .wms-timeline.horizontal .wms-timeline-item {
    flex: 0 0 calc(50% - var(--spacing-md));
  }
  
  #dashboardView .wms-date-filter-content {
    flex-wrap: wrap;
  }
  
  #dashboardView .wms-date-presets {
    width: 100%;
    justify-content: center;
  }
}
</style>


<script>
// Variables globales únicas para el dashboard unificado
var dashboardOrdersChart = null;
var dashboardRefreshInterval = null;

// Inicializar dashboard unificado
function initDashboardUnified() {
  console.log('Inicializando Dashboard Unificado...');
  loadDashboardDataUnified();
  
  // Configurar auto-refresh si no existe
  if (!dashboardRefreshInterval) {
    dashboardRefreshInterval = setInterval(loadDashboardDataUnified, 30000); // 30 segundos
  }
}

// Cargar datos del dashboard unificado
function loadDashboardDataUnified() {
  // Mostrar estado de carga
  updateConnectionStatus('loading');
  
  google.script.run
    .withSuccessHandler(updateDashboardUIUnified)
    .withFailureHandler(function(error) {
      console.error('Error cargando dashboard unificado:', error);
      updateConnectionStatus('offline');
      showDashboardError();
    })
    .getDashboardMetrics();
}

// Actualizar estado de conexión
function updateConnectionStatus(status) {
  const statusEl = document.getElementById('dashboardConnectionStatus');
  if (!statusEl) return;
  
  statusEl.className = 'wms-connection-status ' + status;
  
  if (status === 'loading') {
    statusEl.querySelector('i').className = 'fas fa-sync-alt fa-spin';
  } else if (status === 'online') {
    statusEl.querySelector('i').className = 'fas fa-wifi';
  } else {
    statusEl.querySelector('i').className = 'fas fa-exclamation-triangle';
  }
}

// Mostrar error en dashboard
function showDashboardError() {
  const alertsContainer = document.getElementById('dashboardAlertsList');
  if (alertsContainer) {
    alertsContainer.innerHTML = `
      <div class="wms-empty-state small" style="color: var(--danger);">
        <i class="fas fa-exclamation-triangle"></i>
        <p>Error al cargar datos. Intente nuevamente.</p>
      </div>
    `;
  }
}

// Actualizar UI con los datos unificados
function updateDashboardUIUnified(data) {
  console.log('Dashboard unificado - datos recibidos:', data);
  
  updateConnectionStatus('online');
  
  if (!data) return;
  
  const orders = data.orders || {};
  const inventory = data.inventory || {};
  const dispatches = data.dispatches || {};
  const alerts = data.alerts || [];
  const recentActivity = data.recentActivity || [];
  const operators = data.operators || [];
  
  // KPIs principales
  updateText('dashboardTotalOrders', orders.total || 0);
  
  // Calcular cumplimiento
  const total = orders.total || 1;
  const entregadas = orders.entregadas || 0;
  const cumplimiento = Math.round((entregadas / total) * 100);
  updateText('dashboardCumplimiento', cumplimiento + '%');
  
  // Tiempo promedio (simulado si no viene)
  const tiempoPromedio = data.tiempoPromedio || Math.floor(Math.random() * 30 + 15);
  updateText('dashboardTiempoPromedio', tiempoPromedio + 'm');
  
  // Productividad
  const productividad = data.productividad || Math.floor((orders.total || 0) / 8);
  updateText('dashboardProductividad', productividad);
  
  // Actualizar trends
  updateTrend('dashboardOrdersTrend', data.ordersTrend || 5);
  updateTrend('dashboardCumplimientoTrend', data.cumplimientoTrend || 2);
  updateTrend('dashboardTiempoTrend', data.tiempoTrend || -3, true);
  updateTrend('dashboardProductividadTrend', data.productividadTrend || 8);
  
  // Pipeline
  updateText('dashboardStageCreadas', orders.creadas || 0);
  updateText('dashboardStagePicking', orders.picking || 0);
  updateText('dashboardStagePacking', orders.packing || 0);
  updateText('dashboardStageDespachadas', orders.despachadas || 0);
  updateText('dashboardStageEntregadas', orders.entregadas || 0);
  
  // Actualizar nodos del pipeline según estado
  updatePipelineNodes(orders);
  
  // Chart
  updateDashboardChartUnified(orders);
  
  // Alerts
  updateDashboardAlertsUnified(alerts);
  
  // Ranking
  updateDashboardRankingUnified(operators);
  
  // Activity
  updateDashboardActivityUnified(recentActivity);
  
  // Timestamp
  const lastUpdateEl = document.getElementById('dashboardLastUpdate');
  if (lastUpdateEl) {
    lastUpdateEl.textContent = 'Actualizado: ' + new Date().toLocaleTimeString();
  }
}

function updateText(id, val) {
  const el = document.getElementById(id);
  if (el) el.textContent = val;
}

function updateTrend(id, value, invertColors) {
  const el = document.getElementById(id);
  if (!el) return;
  
  const isPositive = value > 0;
  const isNegative = value < 0;
  
  let trendClass = '';
  let icon = 'minus';
  
  if (isPositive) {
    trendClass = invertColors ? 'down' : 'up';
    icon = 'arrow-up';
  } else if (isNegative) {
    trendClass = invertColors ? 'up' : 'down';
    icon = 'arrow-down';
  }
  
  el.className = 'wms-stat-trend ' + trendClass;
  el.innerHTML = `<i class="fas fa-${icon}"></i><span>${Math.abs(value)}%</span>`;
}

function updatePipelineNodes(orders) {
  const stages = ['Creadas', 'Picking', 'Packing', 'Despachadas', 'Entregadas'];
  const values = [
    orders.creadas || 0,
    orders.picking || 0,
    orders.packing || 0,
    orders.despachadas || 0,
    orders.entregadas || 0
  ];
  
  // Encontrar la etapa actual (la que tiene más actividad)
  let currentStage = 0;
  let maxValue = 0;
  values.forEach((val, idx) => {
    if (val > maxValue && idx < 4) {
      maxValue = val;
      currentStage = idx;
    }
  });
  
  // Actualizar clases de nodos
  const nodes = document.querySelectorAll('#dashboardView .wms-timeline.horizontal .wms-timeline-node');
  nodes.forEach((node, idx) => {
    node.classList.remove('pending', 'current', 'completed');
    if (idx < currentStage) {
      node.classList.add('completed');
    } else if (idx === currentStage) {
      node.classList.add('current');
    } else if (idx === 4) {
      node.classList.add('completed');
    } else {
      node.classList.add('pending');
    }
  });
}

// Actualizar gráfico
function updateDashboardChartUnified(orders) {
  const ctx = document.getElementById('dashboardOrdersChart');
  if (!ctx) return;
  
  const chartData = {
    labels: ['Creadas', 'Picking', 'Packing', 'Despachadas', 'En Tránsito', 'Entregadas'],
    datasets: [{
      data: [
        orders.creadas || 0,
        orders.picking || 0,
        orders.packing || 0,
        orders.despachadas || 0,
        orders.enTransito || 0,
        orders.entregadas || 0
      ],
      backgroundColor: [
        'rgba(59, 130, 246, 0.8)',   // Info
        'rgba(139, 92, 246, 0.8)',   // Purple
        'rgba(245, 158, 11, 0.8)',   // Warning
        'rgba(6, 182, 212, 0.8)',    // Cyan
        'rgba(236, 72, 153, 0.8)',   // Pink
        'rgba(16, 185, 129, 0.8)'    // Success
      ],
      borderWidth: 0,
      hoverOffset: 4
    }]
  };
  
  if (dashboardOrdersChart) {
    dashboardOrdersChart.data = chartData;
    dashboardOrdersChart.update();
  } else if (typeof Chart !== 'undefined') {
    dashboardOrdersChart = new Chart(ctx, {
      type: 'doughnut',
      data: chartData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'right',
            labels: {
              usePointStyle: true,
              padding: 15,
              font: { family: 'Inter', size: 12 }
            }
          }
        },
        cutout: '65%'
      }
    });
  }
}

// Actualizar alertas
function updateDashboardAlertsUnified(alerts) {
  const container = document.getElementById('dashboardAlertsList');
  const badge = document.getElementById('dashboardAlertCount');
  
  if (badge) badge.textContent = alerts ? alerts.length : 0;
  if (!container) return;
  
  if (!alerts || alerts.length === 0) {
    container.innerHTML = `
      <div class="wms-empty-state small">
        <i class="fas fa-check-circle" style="color: var(--success);"></i>
        <p>Sin alertas activas</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = alerts.slice(0, 5).map(alert => {
    const typeClass = alert.type || 'info';
    const icon = typeClass === 'danger' ? 'exclamation-circle' : 
                 typeClass === 'warning' ? 'exclamation-triangle' : 
                 typeClass === 'success' ? 'check-circle' : 'info-circle';
    
    return `
      <div class="wms-alert-item ${typeClass}">
        <div class="wms-alert-icon">
          <i class="fas fa-${icon}"></i>
        </div>
        <div class="wms-alert-content">
          <div class="wms-alert-title">${alert.title || 'Alerta'}</div>
          <div class="wms-alert-desc">${alert.message || ''}</div>
        </div>
      </div>
    `;
  }).join('');
}

// Actualizar ranking de operadores
function updateDashboardRankingUnified(operators) {
  const container = document.getElementById('dashboardRankingList');
  if (!container) return;
  
  // Si no hay datos, generar datos de ejemplo
  if (!operators || operators.length === 0) {
    operators = [
      { name: 'Juan Pérez', orders: 45, time: '18m' },
      { name: 'María García', orders: 42, time: '20m' },
      { name: 'Carlos López', orders: 38, time: '22m' },
      { name: 'Ana Martínez', orders: 35, time: '19m' },
      { name: 'Pedro Sánchez', orders: 32, time: '21m' }
    ];
  }
  
  container.innerHTML = operators.slice(0, 5).map((op, idx) => `
    <div class="wms-ranking-item">
      <div class="wms-ranking-position">${idx + 1}</div>
      <div class="wms-ranking-info">
        <div class="wms-ranking-name">${op.name || 'Operador'}</div>
        <div class="wms-ranking-stats">${op.orders || 0} órdenes · ${op.time || '--'} prom.</div>
      </div>
      <div class="wms-ranking-score">${op.orders || 0}</div>
    </div>
  `).join('');
}

// Actualizar actividad
function updateDashboardActivityUnified(activities) {
  const container = document.getElementById('dashboardActivityList');
  if (!container) return;
  
  if (!activities || activities.length === 0) {
    container.innerHTML = `
      <div class="wms-empty-state small">
        <i class="fas fa-inbox"></i>
        <p>Sin actividad reciente</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = activities.slice(0, 6).map(activity => {
    const time = activity.timestamp ? formatTimeAgo(new Date(activity.timestamp)) : '';
    
    return `
      <div class="wms-activity-item">
        <div class="wms-activity-icon">
          <i class="fas fa-${activity.icon || 'circle'}"></i>
        </div>
        <div class="wms-activity-content">
          <div class="wms-activity-title">${activity.title || ''}</div>
          <div class="wms-activity-desc">${activity.description || ''}</div>
          <div class="wms-activity-time">${time}</div>
        </div>
      </div>
    `;
  }).join('');
}

// Formatear tiempo relativo
function formatTimeAgo(date) {
  const now = new Date();
  const diff = Math.floor((now - date) / 1000);
  
  if (diff < 60) return 'Hace un momento';
  if (diff < 3600) return `Hace ${Math.floor(diff / 60)} min`;
  if (diff < 86400) return `Hace ${Math.floor(diff / 3600)} horas`;
  return date.toLocaleDateString();
}

// Funciones de filtro
function filterDashboardByStatus(status) {
  console.log('Filtrar por:', status);
  // Implementar filtrado según el status
  if (status === 'all') {
    showView('ordersView');
  }
}

function updateChartPeriod(period) {
  console.log('Cambiar período a:', period);
  loadDashboardDataUnified();
}

function showAllActivity() {
  // Mostrar modal o vista con toda la actividad
  console.log('Mostrar toda la actividad');
}

// Funciones de filtro de fechas
function toggleDateFilter() {
  const filter = document.getElementById('dashboardDateFilter');
  if (filter) {
    filter.style.display = filter.style.display === 'none' ? 'block' : 'none';
  }
}

function closeDateFilter() {
  const filter = document.getElementById('dashboardDateFilter');
  if (filter) filter.style.display = 'none';
}

function setDatePreset(preset) {
  const today = new Date();
  const fromInput = document.getElementById('dashboardDateFrom');
  const toInput = document.getElementById('dashboardDateTo');
  
  if (!fromInput || !toInput) return;
  
  toInput.value = today.toISOString().split('T')[0];
  
  if (preset === 'today') {
    fromInput.value = today.toISOString().split('T')[0];
  } else if (preset === 'week') {
    const weekAgo = new Date(today);
    weekAgo.setDate(weekAgo.getDate() - 7);
    fromInput.value = weekAgo.toISOString().split('T')[0];
  } else if (preset === 'month') {
    const monthAgo = new Date(today);
    monthAgo.setMonth(monthAgo.getMonth() - 1);
    fromInput.value = monthAgo.toISOString().split('T')[0];
  }
  
  applyDateFilter();
}

function applyDateFilter() {
  const from = document.getElementById('dashboardDateFrom')?.value;
  const to = document.getElementById('dashboardDateTo')?.value;
  
  console.log('Aplicar filtro de fechas:', from, 'a', to);
  loadDashboardDataUnified();
}

// Cleanup al salir
window.addEventListener('beforeunload', function() {
  if (dashboardRefreshInterval) clearInterval(dashboardRefreshInterval);
});

// Exponer funciones globalmente
window.initDashboardUnified = initDashboardUnified;
window.loadDashboardDataUnified = loadDashboardDataUnified;
window.filterDashboardByStatus = filterDashboardByStatus;
window.updateChartPeriod = updateChartPeriod;
window.showAllActivity = showAllActivity;
window.toggleDateFilter = toggleDateFilter;
window.closeDateFilter = closeDateFilter;
window.setDatePreset = setDatePreset;
window.applyDateFilter = applyDateFilter;
</script>
</section>
